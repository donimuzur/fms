@model FMS.Website.Models.FleetModel
@using FMS.Core

<section class="content-header">
    <h1>
        Master Data Fleet Upload
    </h1>
</section>
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="Row">
                <div class="form-group">
                    <input type="file" id="upload" name="upload" />
                </div>
                <div class="form-group">
                    <Button type="button" id="btnupload" value="upload" name="upload" class="btn bg-blue">Generate</Button>
                </div>
            </div>
            @using (Html.BeginForm("Upload","MstFleet"))
            {
            <div class="box-header" style="overflow-y: auto;">
                <div class="box" style="overflow-y: auto;">
                    <div class="box-body">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Police Number</th>
                                    <th>Chasis Number</th>
                                    <th>Engine Number</th>
                                    <th>Employee ID</th>
                                    <th>Employee Name</th>
                                    <th>Group Level</th>
                                    <th>Actual Group</th>
                                    <th>Assigned To</th>
                                    <th>Cost Center</th>
                                    <th>Vendor Name</th>
                                    <th>Manufacturer.</th>
                                    <th>Model</th>
                                    <th>Series</th>
                                    <th>Body Type</th>
                                    <th>Color</th>
                                    <th>Transmission</th>
                                    <th>Car Group Level</th>
                                    <th>Fuel Type</th>
                                    <th>Branding</th>
                                    <th>Airbag</th>
                                    <th>Vehicle Year</th>
                                    <th>Vehicle Type</th>
                                    <th>Vehicle Usage</th>
                                    <th>Supply Method</th>
                                    <th>City</th>
                                    <th>Address</th>
                                    <th>Purpose</th>
                                    <th>Vat</th>
                                    <th>Restitution</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Termination Date</th>
                                    <th>PO Number</th>
                                    <th>PO Line</th>
                                    <th>Start Contract</th>
                                    <th>End Contract</th>
                                    <th>Price</th>
                                    <th>Vehicle Status</th>
                                </tr>
                            </thead>
                            <tbody  id="tb-upload-excel">
                              
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="Row">
                <button class="btn bg-blue" type="submit" id="btnSave">Save</button>
                <a href="@Url.Action("Index", "MstFleet")" title="Cancel"><i class="btn bg-gray">Cancel</i></a>
            </div>
            }
        </div>
    </div>
</section>


<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script type="text/javascript">

    $('#btnSave').prop('disabled', true);

    function createColumn(text) {
        return '<td>' + text + '</td>';
    }
    var uploaditems = [];

    function createColumnWithHiddenField(text, name) {
        return '<td><input type="hidden" name="' + name + '" value="' + text + '">' + text + '</td>';
    }

    function createColumnWithHiddenFieldDate(text, name) {
        if (new String(text).valueOf() == "null")
        {
            return '<td><input type="hidden" name="' + name + '" >' + text + '  1</td>';
        }
        else
        {
            var date = new Date(new String(text).valueOf());
            //return '<td><input type="hidden" name="' + name + '" value="' + text + '"><span class="date">' + date.getDate().toString() + '-' + date.getMonth().toString() + '-' + date.getFullYear().toString() + '  2</span></td>';
            return '<td><input type="hidden" name="' + name + '" value="' + text + '">' + text + ' 2 </td>';
        }
        
    }

    function createColumnWithHiddenFieldDecimal(text, name) {
        return '<td><input type="hidden" name="' + name + '" value="' + text + '"><span class="decimal">' + text + '</span></td>';
    }

    $('#btnupload').click(function () {
        uploadXmlFile();
    });

    function uploadXmlFile() {
        var postUrl = '@Url.Action("UploadFile", "MstFleet")';
        var fileName = $('[name="upload"]').val().trim();
        var pos = fileName.lastIndexOf('.');
        var extension = (pos <= 0) ? '' : fileName.substring(pos);

        if (extension != '.xlsx') {
            alert('Please browse a correct excel file to upload');
            return false;
        }

        var formData = new FormData();
        var totalFiles = document.getElementById("upload").files.length;
        for (var i = 0; i < totalFiles; i++) {
            var file = document.getElementById("upload").files[i];
            formData.append("upload", file);
        }
        $.ajax({
            type: "POST",
            url: postUrl,
            data: formData,
            dataType: 'html',
            contentType: false,
            processData: false,

            success: function (response) {
                $('#tb-upload-excel').html('');
                uploaditems = JSON.parse(response);
                var error = "";
                for (var i = 0; i < uploaditems.length; i++) {
                    var tr = '<tr>' +
                            createColumn(i + 1) +
                            createColumnWithHiddenField(uploaditems[i].PoliceNumber, 'Model.Details[' + i + '].PoliceNumber') +
                            createColumnWithHiddenField(uploaditems[i].ChasisNumber, 'Model.Details[' + i + '].ChasisNumber') +
                            createColumnWithHiddenField(uploaditems[i].EngineNumber, 'Model.Details[' + i + '].EngineNumber') +
                            createColumnWithHiddenField(uploaditems[i].EmployeeID, 'Model.Details[' + i + '].EmployeeID') +
                            createColumnWithHiddenField(uploaditems[i].EmployeeName, 'Model.Details[' + i + '].EmployeeName') +
                            createColumnWithHiddenField(uploaditems[i].GroupLevel, 'Model.Details[' + i + '].GroupLevel') +
                            createColumnWithHiddenField(uploaditems[i].ActualGroup, 'Model.Details[' + i + '].ActualGroup') +
                            createColumnWithHiddenField(uploaditems[i].AssignedTo, 'Model.Details[' + i + '].AssignedTo') +
                            createColumnWithHiddenField(uploaditems[i].CostCenter, 'Model.Details[' + i + '].CostCenter') +
                            createColumnWithHiddenField(uploaditems[i].VendorName, 'Model.Details[' + i + '].VendorName') +
                            createColumnWithHiddenField(uploaditems[i].Manufacturer, 'Model.Details[' + i + '].Manufacturer') +
                            createColumnWithHiddenField(uploaditems[i].Models, 'Model.Details[' + i + '].Models') +
                            createColumnWithHiddenField(uploaditems[i].Series, 'Model.Details[' + i + '].Series') +
                            createColumnWithHiddenField(uploaditems[i].BodyType, 'Model.Details[' + i + '].BodyType') +
                            createColumnWithHiddenField(uploaditems[i].Color, 'Model.Details[' + i + '].Color') +
                            createColumnWithHiddenField(uploaditems[i].Transmission, 'Model.Details[' + i + '].Transmission') +
                            createColumnWithHiddenField(uploaditems[i].CarGroupLevel, 'Model.Details[' + i + '].CarGroupLevel') +
                            createColumnWithHiddenField(uploaditems[i].FuelType, 'Model.Details[' + i + '].FuelType') +
                            createColumnWithHiddenField(uploaditems[i].Branding, 'Model.Details[' + i + '].Branding') +
                            createColumnWithHiddenField(uploaditems[i].Airbag, 'Model.Details[' + i + '].Airbag') +
                            createColumnWithHiddenField(uploaditems[i].VehicleYear, 'Model.Details[' + i + '].VehicleYear') +
                            createColumnWithHiddenField(uploaditems[i].VehicleType, 'Model.Details[' + i + '].VehicleType') +
                            createColumnWithHiddenField(uploaditems[i].VehicleUsage, 'Model.Details[' + i + '].VehicleUsage') +
                            createColumnWithHiddenField(uploaditems[i].SupplyMethod, 'Model.Details[' + i + '].SupplyMethod') +
                            createColumnWithHiddenField(uploaditems[i].City, 'Model.Details[' + i + '].City') +
                            createColumnWithHiddenField(uploaditems[i].Address, 'Model.Details[' + i + '].Address') +
                            createColumnWithHiddenField(uploaditems[i].Purpose, 'Model.Details[' + i + '].Purpose') +
                            createColumnWithHiddenField(uploaditems[i].Vat, 'Model.Details[' + i + '].Vat') +
                            createColumnWithHiddenField(uploaditems[i].Restitution, 'Model.Details[' + i + '].Restitution') +
                            createColumnWithHiddenFieldDate(uploaditems[i].StartDate, 'Model.Details[' + i + '].StartDate') +
                            createColumnWithHiddenFieldDate(uploaditems[i].EndDate, 'Model.Details[' + i + '].EndDate') +
                            createColumnWithHiddenFieldDate(uploaditems[i].TerminationDate, 'Model.Details[' + i + '].TerminationDate') +
                            createColumnWithHiddenField(uploaditems[i].PoNumber, 'Model.Details[' + i + '].PoNumber') +
                            createColumnWithHiddenField(uploaditems[i].PoLine, 'Model.Details[' + i + '].PoLine') +
                            createColumnWithHiddenFieldDate(uploaditems[i].StartContract, 'Model.Details[' + i + '].StartContract') +
                            createColumnWithHiddenFieldDate(uploaditems[i].EndContract, 'Model.Details[' + i + '].EndContract') +
                            createColumnWithHiddenField(uploaditems[i].Price, 'Model.Details[' + i + '].Price') +
                            createColumnWithHiddenField(uploaditems[i].VehicleStatus, 'Model.Details[' + i + '].VehicleStatus') +
                            '</tr>';
                    $('#tb-upload-excel').append(tr);
                    error += uploaditems[i].Message;
                }
               $('#btnSave').prop('disabled', false);
            }
        });
    };
</script>
